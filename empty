#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

RECALL_SCRIPT="/usr/local/lib/empty/recall.sh"
RECALL_DIR="/usr/local/lib/empty"

# Function to show help message
show_help() {
    echo "Usage: empty [OPTIONS] [file|directory]"
    echo
    echo "Options:"
    echo "  -h, --help     Show this help message"
    echo "  --uninstall    Uninstall empty command"
    echo
    echo "Examples:"
    echo "  empty file.txt          # Empty a file"
    echo "  empty directory/        # Empty a directory"
    echo "  empty --uninstall       # Uninstall empty command"
}

# Function to create recall script
create_recall_script() {
    mkdir -p "$RECALL_DIR"
    cat > "$RECALL_SCRIPT" << 'EOF'
#!/bin/bash
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${RED}The 'empty' command is not installed.${NC}"
echo -e "${YELLOW}To install, run:${NC}"
echo "git clone https://github.com/vasanthfeb13/empty.git"
echo "cd empty"
echo "sudo ./install.sh"

# Create a temporary alias that will show this message
alias empty="$0"
EOF
    chmod +x "$RECALL_SCRIPT"

    # Create a system-wide alias
    echo "alias empty='$RECALL_SCRIPT'" > /etc/profile.d/empty-recall.sh
    chmod +x /etc/profile.d/empty-recall.sh
}

# Function to perform uninstallation
perform_uninstall() {
    echo -e "${YELLOW}Uninstalling empty command...${NC}"
    
    # Create recall script before removing the command
    create_recall_script
    
    # Remove binary
    rm -f /usr/local/bin/empty
    
    # Remove man page
    rm -f /usr/share/man/man1/empty.1.gz
    
    echo -e "${GREEN}Empty command has been uninstalled.${NC}"
    echo -e "${YELLOW}A recall script has been created. Running 'empty' will show installation instructions.${NC}"
    exit 0
}

# Function to empty a file
empty_file() {
    local target="$1"
    if [ -f "$target" ]; then
        : > "$target"
        echo -e "${GREEN}Emptied file: $target${NC}"
    elif [ -d "$target" ]; then
        rm -rf "$target"/*
        echo -e "${GREEN}Emptied directory: $target${NC}"
    else
        echo -e "${RED}Error: $target does not exist${NC}"
        exit 1
    fi
}

# Main logic
main() {
    # Handle options
    case "$1" in
        --help|-h)
            show_help
            exit 0
            ;;
        --uninstall)
            if [ "$EUID" -ne 0 ]; then
                echo -e "${RED}Please run with sudo for uninstallation${NC}"
                exit 1
            fi
            perform_uninstall
            ;;
        "")
            echo -e "${RED}Error: No target specified${NC}"
            show_help
            exit 1
            ;;
        *)
            empty_file "$1"
            ;;
    esac
}

# Run main function
main "$@"
